local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
local savedOrder = {} 
local isSwapMode = false
local firstSelection = nil
local isHidden = false
local isSystemActive = false
local searchFilter = "" 

-- 1. FUNGSI PEMERIKSAAN ITEM (Supaya tak pickup item yang dah ada)
local function hasItem(itemName)
    local char = player.Character
    local bp = player:FindFirstChild("Backpack")
    if char and char:FindFirstChild(itemName) then return true end
    if bp and bp:FindFirstChild(itemName) then return true end
    return false
end

-- 2. SETUP UI UTAMA (Persistent Hotbar)
if CoreGui:FindFirstChild("PersistentHotbar") then
    CoreGui.PersistentHotbar:Destroy()
end

local gui = Instance.new("ScreenGui")
gui.Name = "PersistentHotbar"
gui.ResetOnSpawn = false 
gui.Enabled = true 
gui.Parent = CoreGui 

local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Name = "MainScroll"
scrollFrame.Size = UDim2.new(0, 0, 0, 75)
scrollFrame.Position = UDim2.new(0.5, 0, 1, -100)
scrollFrame.AnchorPoint = Vector2.new(0.5, 0)
scrollFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
scrollFrame.BackgroundTransparency = 0.4
scrollFrame.ScrollBarThickness = 4
scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
scrollFrame.Visible = false
scrollFrame.Parent = gui

Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 12)
local layout = Instance.new("UIListLayout", scrollFrame)
layout.FillDirection = Enum.FillDirection.Horizontal
layout.Padding = UDim.new(0, 8)
layout.VerticalAlignment = Enum.VerticalAlignment.Center
Instance.new("UIPadding", scrollFrame).PaddingLeft = UDim.new(0, 10)
Instance.new("UIPadding", scrollFrame).PaddingRight = UDim.new(0, 10)

-- 3. SEARCH BAR & TOMBOL KAWALAN
local searchBox = Instance.new("TextBox")
searchBox.Name = "SearchBar"
searchBox.Size = UDim2.fromOffset(110, 20)
searchBox.Position = UDim2.new(0.5, -115, 1, -15) 
searchBox.AnchorPoint = Vector2.new(1, 1)
searchBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
searchBox.BackgroundTransparency = 0.3
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.PlaceholderText = "SEARCH..."
searchBox.Font = Enum.Font.GothamBold
searchBox.TextSize = 10
searchBox.Visible = false
searchBox.Parent = gui
Instance.new("UICorner", searchBox).CornerRadius = UDim.new(0, 4)

local btnContainer = Instance.new("Frame")
btnContainer.Size = UDim2.fromOffset(200, 25)
btnContainer.Position = UDim2.new(0.5, 0, 1, -15)
btnContainer.AnchorPoint = Vector2.new(0.5, 1)
btnContainer.BackgroundTransparency = 1
btnContainer.Parent = gui

local btnLayout = Instance.new("UIListLayout", btnContainer)
btnLayout.FillDirection = Enum.FillDirection.Horizontal
btnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
btnLayout.Padding = UDim.new(0, 5)

local function createBtn(text, color)
    local b = Instance.new("TextButton")
    b.Size = UDim2.fromOffset(60, 20)
    b.BackgroundColor3 = color or Color3.fromRGB(30, 30, 30)
    b.BackgroundTransparency = 0.2
    b.Text = text
    b.TextColor3 = Color3.new(1,1,1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 10
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 4)
    b.Parent = btnContainer
    return b
end

local hideBtn = createBtn("HIDE")
local pickupBtn = createBtn("PICKUP", Color3.fromRGB(0, 170, 127))
local editBtn = createBtn("EDIT")

-- 4. FUNGSI PICKUP (LOGIK ASAL YANG ANDA MAHU)
local function createFloatingPickup(target, isPrompt, itemName)
    if CoreGui:FindFirstChild("FloatingPickup_" .. itemName) then return end

    local floatGui = Instance.new("ScreenGui")
    floatGui.Name = "FloatingPickup_" .. itemName
    floatGui.Parent = CoreGui
    
    local fBtn = Instance.new("TextButton")
    fBtn.Size = UDim2.fromOffset(55, 55)
    fBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    fBtn.BackgroundTransparency = 0.3
    fBtn.Text = isPrompt and "HOLD\n"..itemName:upper() or "GET\n"..itemName:upper()
    fBtn.Font = Enum.Font.GothamBold
    fBtn.TextSize = 8
    fBtn.TextColor3 = Color3.new(0,0,0)
    fBtn.Parent = floatGui
    Instance.new("UICorner", fBtn).CornerRadius = UDim.new(1, 0)
    local stroke = Instance.new("UIStroke", fBtn)
    stroke.Thickness = 3
    stroke.Color = Color3.fromRGB(0, 255, 127)

    task.spawn(function()
        while target and target.Parent and floatGui.Parent do
            if hasItem(itemName) then break end
            
            -- Cari kedudukan visual objek
            local targetPart = isPrompt and target.Parent or (target:IsA("Tool") and target:FindFirstChild("Handle") or target)
            if not targetPart or not targetPart:IsA("BasePart") then break end
            
            local dist = (player.Character.HumanoidRootPart.Position - targetPart.Position).Magnitude
            if dist > 15 then break end

            local pos, onScreen = workspace.CurrentCamera:WorldToScreenPoint(targetPart.Position)
            if onScreen then
                fBtn.Visible = true
                fBtn.Position = UDim2.fromOffset(pos.X - 27, pos.Y - 27)
            else
                fBtn.Visible = false
            end
            task.wait()
        end
        floatGui:Destroy()
    end)

    fBtn.MouseButton1Click:Connect(function()
        if isPrompt then
            target:InputHoldBegin()
            task.wait(target.HoldDuration + 0.1)
            target:InputHoldEnd()
        else
            local char = player.Character
            local handle = target:IsA("Tool") and target:FindFirstChild("Handle") or target
            if char and char:FindFirstChild("HumanoidRootPart") and handle then
                firetouchinterest(char.HumanoidRootPart, handle, 0)
                task.wait()
                firetouchinterest(char.HumanoidRootPart, handle, 1)
            end
        end
        floatGui:Destroy()
    end)
end

-- LOGIK CLICK TOMBOL PICKUP (SCAN workspace.PickItem)
pickupBtn.MouseButton1Click:Connect(function()
    local pickFolder = workspace:FindFirstChild("PickItem")
    if not pickFolder then return end

    for _, obj in pairs(pickFolder:GetDescendants()) do
        local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if not root then break end

        if obj:IsA("ProximityPrompt") then
            local dist = (root.Position - obj.Parent.Position).Magnitude
            if dist < 12 and not hasItem(obj.Parent.Name) then 
                createFloatingPickup(obj, true, obj.Parent.Name) 
            end
        elseif obj:IsA("Tool") and obj:FindFirstChild("Handle") then
            local dist = (root.Position - obj.Handle.Position).Magnitude
            if dist < 12 and not hasItem(obj.Name) then 
                createFloatingPickup(obj, false, obj.Name) 
            end
        end
    end
end)

-- 5. HOTBAR LOGIC (BAHAGIAN 6 ASAL ANDA - DIPULIHKAN SEPENUHNYA)
local function updateGearFrame()
    local char = player.Character
    local backpack = player:FindFirstChild("Backpack")
    if not char or not backpack then return end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    local currentTools = {}
    local foundNames = {}

    for _, t in pairs(backpack:GetChildren()) do if t:IsA("Tool") then currentTools[t.Name] = t; table.insert(foundNames, t.Name) end end
    for _, t in pairs(char:GetChildren()) do if t:IsA("Tool") then currentTools[t.Name] = t; table.insert(foundNames, t.Name) end end

    if #foundNames > 3 then
        if not isSystemActive then 
            isSystemActive = true
            scrollFrame.Visible = not isHidden 
            searchBox.Visible = not isHidden
        end
    else
        isSystemActive = false
        scrollFrame.Visible = false
        searchBox.Visible = false
        scrollFrame.Size = UDim2.new(0, 0, 0, 75)
        return 
    end

    for _, name in ipairs(foundNames) do
        local exists = false
        for _, savedName in ipairs(savedOrder) do if savedName == name then exists = true break end end
        if not exists then table.insert(savedOrder, name) end
    end
    for i = #savedOrder, 1, -1 do
        if not currentTools[savedOrder[i]] then table.remove(savedOrder, i) end
    end

    for _, child in pairs(scrollFrame:GetChildren()) do if child:IsA("TextButton") then child:Destroy() end end
    
    local visibleCount = 0
    for index, toolName in ipairs(savedOrder) do
        if searchFilter ~= "" and not string.find(toolName:lower(), searchFilter:lower()) then continue end
        local tool = currentTools[toolName]
        if not tool then continue end
        visibleCount = visibleCount + 1
        
        local isEquipped = (tool.Parent == char)
        local slot = Instance.new("TextButton")
        slot.Size = UDim2.fromOffset(60, 60)
        slot.BackgroundColor3 = isSwapMode and ((firstSelection == index) and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(35, 55, 75)) or (isEquipped and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(35, 35, 35))
        slot.Text = ""
        slot.Parent = scrollFrame
        Instance.new("UICorner", slot).CornerRadius = UDim.new(0, 10)

        if isEquipped and not isSwapMode then
            local stroke = Instance.new("UIStroke", slot)
            stroke.Thickness = 2.5
            stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
            task.spawn(function()
                while isEquipped and slot.Parent do
                    stroke.Color = Color3.fromHSV(tick() * 0.2 % 1, 0.8, 1)
                    task.wait()
                end
            end)
        end

        local slotNum = Instance.new("TextLabel")
        slotNum.Size = UDim2.fromOffset(20, 20)
        slotNum.Position = UDim2.new(0, 5, 0, 2)
        slotNum.BackgroundTransparency = 1
        slotNum.Text = tostring(index)
        slotNum.TextColor3 = Color3.new(1,1,1)
        slotNum.TextTransparency = 0.5
        slotNum.Font = Enum.Font.GothamBold
        slotNum.TextSize = 12
        slotNum.Parent = slot

        if tool.TextureId ~= "" then
            local icon = Instance.new("ImageLabel")
            icon.Size = UDim2.fromScale(0.75, 0.75)
            icon.Position = UDim2.fromScale(0.5, 0.5)
            icon.AnchorPoint = Vector2.new(0.5, 0.5)
            icon.BackgroundTransparency = 1
            icon.Image = tool.TextureId
            icon.ZIndex = 2
            icon.Parent = slot
        else
            local nameTag = Instance.new("TextLabel")
            nameTag.Size = UDim2.fromScale(0.85, 0.6)
            nameTag.Position = UDim2.fromScale(0.5, 0.5)
            nameTag.AnchorPoint = Vector2.new(0.5, 0.5)
            nameTag.BackgroundTransparency = 1
            nameTag.TextColor3 = Color3.new(1,1,1)
            nameTag.Font = Enum.Font.SourceSansBold
            nameTag.TextSize = 10
            nameTag.TextWrapped = true
            nameTag.Text = tool.Name:upper()
            nameTag.ZIndex = 2
            nameTag.Parent = slot
        end

        slot.Activated:Connect(function()
            if isSwapMode then
                if not firstSelection then firstSelection = index; updateGearFrame() else
                    local temp = savedOrder[firstSelection]; savedOrder[firstSelection] = savedOrder[index]; savedOrder[index] = temp
                    firstSelection = nil; updateGearFrame()
                end
            else
                if tool.Parent == char then hum:UnequipTools() else hum:EquipTool(tool) end
            end
        end)
    end

    if visibleCount > 8 then
        scrollFrame.AutomaticSize = Enum.AutomaticSize.None
        scrollFrame.Size = UDim2.new(0, (60 * 8) + (8 * 9) + 20, 0, 75)
        scrollFrame.CanvasSize = UDim2.new(0, layout.AbsoluteContentSize.X + 20, 0, 0)
        scrollFrame.ScrollingEnabled = true
    else
        scrollFrame.AutomaticSize = Enum.AutomaticSize.X
        scrollFrame.ScrollingEnabled = false
    end
end


-- 6. EVENTS & LISTENERS
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
    searchFilter = searchBox.Text
    updateGearFrame()
end)

hideBtn.MouseButton1Click:Connect(function()
    isHidden = not isHidden
    scrollFrame.Visible = (not isHidden) and isSystemActive
    searchBox.Visible = (not isHidden) and isSystemActive 
    hideBtn.Text = isHidden and "SHOW" or "HIDE"
end)

editBtn.MouseButton1Click:Connect(function()
    if not isSystemActive then return end
    isSwapMode = not isSwapMode
    firstSelection = nil
    editBtn.BackgroundColor3 = isSwapMode and Color3.fromRGB(255, 85, 85) or Color3.fromRGB(30, 30, 30)
    editBtn.Text = isSwapMode and "SAVING..." or "EDIT"
    updateGearFrame()
end)

local function setupListeners()
    local char = player.Character or player.CharacterAdded:Wait()
    local bp = player:WaitForChild("Backpack")
    bp.ChildAdded:Connect(updateGearFrame)
    bp.ChildRemoved:Connect(updateGearFrame)
    char.ChildAdded:Connect(updateGearFrame)
    char.ChildRemoved:Connect(updateGearFrame)
    updateGearFrame()
end

player.CharacterAdded:Connect(setupListeners)
setupListeners()
