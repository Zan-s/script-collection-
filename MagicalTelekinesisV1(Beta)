local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Stats = game:GetService("Stats")
local CoreGui = game:GetService("CoreGui") -- Ditambah untuk bypass PlayerGui detection

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Pilih tempat simpanan UI yang selamat (Bypass Anti-Cheat)
local safeParent = (gethui and gethui()) or CoreGui or player:WaitForChild("PlayerGui")

-- --- CONFIGURATION ---
local DEFAULT_DIST = 15
local DEFAULT_HEIGHT = 0
local DEFAULT_SIDE = 0
local movingPart = nil
local followDistance = DEFAULT_DIST
local heightOffset = DEFAULT_HEIGHT
local sideOffset = DEFAULT_SIDE
local walkSpeedActive = false
local rotationActive = true
local shiftLockActive = false 
local rotationX, rotationY, rotationZ = 0, 0, 0

-- Physics Constraints
local alignPos = Instance.new("AlignPosition")
alignPos.MaxForce = 1e12; alignPos.MaxVelocity = math.huge; alignPos.Responsiveness = 60 
alignPos.Mode = Enum.PositionAlignmentMode.OneAttachment

local alignOri = Instance.new("AlignOrientation")
alignOri.MaxTorque = 1e12; alignOri.Responsiveness = 60
alignOri.Mode = Enum.OrientationAlignmentMode.OneAttachment

-- Highlight Effect (Glow)
local highlight = Instance.new("Highlight")
highlight.Name = "TeleGlow"
highlight.FillTransparency = 0.5
highlight.OutlineTransparency = 0

-- --- FUNCTIONS ---
local function stopMoving()
    if movingPart then 
        movingPart.CanCollide = true 
        local att = movingPart:FindFirstChild("TeleAtt")
        if att then att:Destroy() end
        movingPart.AssemblyLinearVelocity = Vector3.new(0,-1,0)
    end
    movingPart = nil
    alignPos.Enabled = false; alignOri.Enabled = false
    alignPos.Parent = nil; alignOri.Parent = nil
    highlight.Adornee = nil
    highlight.Parent = nil
end

local function togglePartMove(part)
    if movingPart == part then stopMoving() return end
    stopMoving() 
    if part and not part.Anchored then
        local target = part
        if part.Parent:FindFirstChild("Humanoid") then 
            target = part.Parent:FindFirstChild("HumanoidRootPart") or part 
        end
        movingPart = target
        highlight.Adornee = movingPart
        highlight.Parent = movingPart
        local att = Instance.new("Attachment", movingPart)
        att.Name = "TeleAtt"
        alignPos.Attachment0 = att; alignOri.Attachment0 = att
        alignPos.Parent = movingPart; alignOri.Parent = movingPart
        alignPos.Enabled = true; alignOri.Enabled = rotationActive
        movingPart.AssemblyLinearVelocity = Vector3.new(0, 0.1, 0)
    end
end

-- --- UI DRAGGABLE ---
local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = frame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
    end)
end

-- --- UI SYSTEM ---
local function createUI()
    if safeParent:FindFirstChild("TeleMasterV11") then safeParent.TeleMasterV11:Destroy() end
    
    local screenGui = Instance.new("ScreenGui", safeParent)
    screenGui.Name = "TeleMasterV11"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true

    local function createBtn(name, text, pos, size, color, parent)
        local b = Instance.new("TextButton", parent); b.Name = name; b.Size = size; b.Position = pos; b.Text = text
        b.BackgroundColor3 = color; b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.GothamBold; b.TextSize = 13
        Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6); return b
    end

    local main = Instance.new("Frame", screenGui)
    main.Name = "Main"; main.Size = UDim2.new(0, 220, 0, 320); main.Position = UDim2.new(0.1, 0, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15); Instance.new("UICorner", main).CornerRadius = UDim.new(0, 10); makeDraggable(main)

    local scroll = Instance.new("ScrollingFrame", main)
    scroll.Name = "ContentScroll"; scroll.Size = UDim2.new(1, 0, 1, -45); scroll.Position = UDim2.new(0, 0, 0, 45)
    scroll.BackgroundTransparency = 1; scroll.BorderSizePixel = 0; scroll.ScrollBarThickness = 4
    scroll.CanvasSize = UDim2.new(0, 0, 0, 520); scroll.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100)

    local fpsLabel = Instance.new("TextLabel", main); fpsLabel.Size = UDim2.new(0.5, 0, 0, 20); fpsLabel.Position = UDim2.new(0, 0, 0, -25); fpsLabel.BackgroundTransparency = 1; fpsLabel.Font = Enum.Font.Code; fpsLabel.TextSize = 13; fpsLabel.TextXAlignment = Enum.TextXAlignment.Left; fpsLabel.TextColor3 = Color3.new(1,1,1)
    local pingLabel = Instance.new("TextLabel", main); pingLabel.Size = UDim2.new(0.5, 0, 0, 20); pingLabel.Position = UDim2.new(0.5, 0, 0, -25); pingLabel.BackgroundTransparency = 1; pingLabel.Font = Enum.Font.Code; pingLabel.TextSize = 13; pingLabel.TextXAlignment = Enum.TextXAlignment.Right; pingLabel.TextColor3 = Color3.new(1,1,1)

    -- STATS LOGIC
    local lastTime, frameCount, fps = tick(), 0, 0
    RunService.RenderStepped:Connect(function()
        frameCount += 1
        if tick() - lastTime >= 1 then fps = frameCount; frameCount = 0; lastTime = tick() end
        fpsLabel.Text = "FPS: "..fps
        local ping = math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue())
        pingLabel.Text = "Ping: "..ping.."ms "
        
        if shiftLockActive then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local root = player.Character.HumanoidRootPart
                local lookAt = Vector3.new(camera.CFrame.LookVector.X, 0, camera.CFrame.LookVector.Z)
                root.CFrame = CFrame.new(root.Position, root.Position + lookAt)
            end
        end
        if movingPart then
            highlight.FillColor = Color3.fromHSV(tick()%5/5, 0.8, 1)
            highlight.OutlineColor = Color3.fromHSV(tick()%5/5, 1, 1)
        end
    end)

    createBtn("Title", "TGun By:Dinozan ", UDim2.new(0,0,0,0), UDim2.new(1,0,0,40), Color3.fromRGB(30,30,30), main)
    
    local slBtn = createBtn("Shiftlock", "S.Lock: OFF", UDim2.new(0.25, 0, 0, 10), UDim2.new(0.5, 0, 0, 25), Color3.fromRGB(40, 40, 40), scroll)
    slBtn.TextSize = 11
    local slStroke = Instance.new("UIStroke", slBtn); slStroke.Thickness = 2; slStroke.Color = Color3.new(1, 0, 0)

    local hUp = createBtn("HUp", "‚Üë HEIGHT", UDim2.new(0.05,0,0.1,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(45,45,45), scroll)
    local hDown = createBtn("HDown", "‚Üì HEIGHT", UDim2.new(0.52,0,0.1,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(45,45,45), scroll)
    local sLeft = createBtn("SLeft", "‚Üê LEFT", UDim2.new(0.05,0,0.18,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(45,45,45), scroll)
    local sRight = createBtn("SRight", "RIGHT ‚Üí", UDim2.new(0.52,0,0.18,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(45,45,45), scroll)
    local dPlus = createBtn("DPlus", "+ DIST", UDim2.new(0.05,0,0.26,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(30,55,85), scroll)
    local dMinus = createBtn("DMinus", "- DIST", UDim2.new(0.52,0,0.26,0), UDim2.new(0.43,0,0,35), Color3.fromRGB(30,55,85), scroll)
    local rotBtn = createBtn("RotBtn", "‚öôÔ∏è REMOTE", UDim2.new(0.05,0,0.35,0), UDim2.new(0.9,0,0,40), Color3.fromRGB(70,35,110), scroll)
    local flingBtn = createBtn("Fling", "üî• FLING", UDim2.new(0.05,0,0.44,0), UDim2.new(0.9,0,0,40), Color3.fromRGB(150,45,45), scroll)
    local sToggle = createBtn("SToggle", "WALKSPEED: OFF", UDim2.new(0.05,0,0.53,0), UDim2.new(0.9,0,0,35), Color3.fromRGB(40,40,40), scroll)
    
    local sInput = Instance.new("TextBox", scroll)
    sInput.Name = "SpeedVal"; sInput.Size = UDim2.new(0.9,0,0,30); sInput.Position = UDim2.new(0.05,0,0.61,0); sInput.Text = "50"; sInput.BackgroundColor3 = Color3.fromRGB(5,5,5); sInput.TextColor3 = Color3.new(1,1,1); Instance.new("UICorner", sInput)

    local resetBtn = createBtn("Reset", "‚ôªÔ∏è RESET SETTINGS", UDim2.new(0.05,0,0.69,0), UDim2.new(0.9,0,0,40), Color3.fromRGB(180,90,0), scroll)
    local closeBtn = createBtn("Close", "‚ùå CLOSE UI", UDim2.new(0.05,0,0.78,0), UDim2.new(0.9,0,0,40), Color3.fromRGB(40,40,40), scroll)

    local remote = Instance.new("Frame", screenGui); remote.Name = "Remote"; remote.Size = UDim2.new(0, 180, 0, 280); remote.Position = UDim2.new(0.5, 0, 0.3, 0); remote.BackgroundColor3 = Color3.fromRGB(25, 25, 25); remote.Visible = false; Instance.new("UICorner", remote).CornerRadius = UDim.new(0, 10); makeDraggable(remote)
    local rToggle = createBtn("RToggle", "ROTATION: ON", UDim2.new(0.1,0,0.05,0), UDim2.new(0.8,0,0,35), Color3.fromRGB(40,150,40), remote)
    local rxP = createBtn("XP", "X+", UDim2.new(0.1,0,0.25,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rxM = createBtn("XM", "X-", UDim2.new(0.55,0,0.25,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local ryP = createBtn("YP", "Y+", UDim2.new(0.1,0,0.45,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local ryM = createBtn("YM", "Y-", UDim2.new(0.55,0,0.45,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rzP = createBtn("ZP", "Z+", UDim2.new(0.1,0,0.65,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rzM = createBtn("ZM", "Z-", UDim2.new(0.55,0,0.65,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)

    -- LOGIC BINDING
    slBtn.MouseButton1Click:Connect(function()
        shiftLockActive = not shiftLockActive
        slBtn.Text = "S.Lock: " .. (shiftLockActive and "ON" or "OFF")
        slStroke.Color = shiftLockActive and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if player.Character and player.Character:FindFirstChild("Humanoid") then player.Character.Humanoid.AutoRotate = not shiftLockActive end
        if not shiftLockActive then UserInputService.MouseBehavior = Enum.MouseBehavior.Default end
    end)

    hUp.MouseButton1Click:Connect(function() heightOffset += 2 end)
    hDown.MouseButton1Click:Connect(function() heightOffset -= 2 end)
    sLeft.MouseButton1Click:Connect(function() sideOffset -= 2 end)
    sRight.MouseButton1Click:Connect(function() sideOffset += 2 end)
    dPlus.MouseButton1Click:Connect(function() followDistance += 5 end)
    dMinus.MouseButton1Click:Connect(function() followDistance = math.max(2, followDistance - 5) end)
    rotBtn.MouseButton1Click:Connect(function() remote.Visible = not remote.Visible end)
    flingBtn.MouseButton1Click:Connect(function() if movingPart then local p = movingPart; stopMoving(); p.AssemblyLinearVelocity = camera.CFrame.LookVector * 2200 end end)
    
    sToggle.MouseButton1Click:Connect(function() 
        walkSpeedActive = not walkSpeedActive
        sToggle.Text = "WALKSPEED: "..(walkSpeedActive and "ON" or "OFF")
        sToggle.BackgroundColor3 = walkSpeedActive and Color3.fromRGB(40,150,40) or Color3.fromRGB(40,40,40)
        if not walkSpeedActive and player.Character and player.Character:FindFirstChild("Humanoid") then player.Character.Humanoid.WalkSpeed = 16 end
    end)

    resetBtn.MouseButton1Click:Connect(function()
        followDistance, heightOffset, sideOffset, rotationX, rotationY, rotationZ, shiftLockActive = DEFAULT_DIST, DEFAULT_HEIGHT, DEFAULT_SIDE, 0, 0, 0, false
        slBtn.Text = "S.Lock: OFF"; slStroke.Color = Color3.new(1,0,0); walkSpeedActive = false; sToggle.Text = "WALKSPEED: OFF"
    end)
    
    closeBtn.MouseButton1Click:Connect(function() screenGui:Destroy() end)
    rToggle.MouseButton1Click:Connect(function() rotationActive = not rotationActive; rToggle.Text = "ROTATION: "..(rotationActive and "ON" or "OFF"); rToggle.BackgroundColor3 = rotationActive and Color3.fromRGB(40,150,40) or Color3.fromRGB(150,40,40); alignOri.Enabled = rotationActive end)
    rxP.MouseButton1Click:Connect(function() rotationX += 30 end); rxM.MouseButton1Click:Connect(function() rotationX -= 30 end)
    ryP.MouseButton1Click:Connect(function() rotationY += 30 end); ryM.MouseButton1Click:Connect(function() rotationY -= 30 end)
    rzP.MouseButton1Click:Connect(function() rotationZ += 30 end); rzM.MouseButton1Click:Connect(function() rotationZ -= 30 end)

    local menu = createBtn("MENU", "‚ò∞", UDim2.new(0.02,0,0.1,0), UDim2.new(0,45,0,45), Color3.fromRGB(20,20,20), screenGui)
    Instance.new("UICorner", menu).CornerRadius = UDim.new(0, 22); makeDraggable(menu)
    menu.MouseButton1Click:Connect(function() main.Visible = not main.Visible end)
end

-- --- MAIN LOOP ---
RunService.Heartbeat:Connect(function()
    local char = player.Character; local root = char and char:FindFirstChild("HumanoidRootPart"); local hum = char and char:FindFirstChild("Humanoid")
    if hum and walkSpeedActive then 
        local gui = safeParent:FindFirstChild("TeleMasterV11")
        if gui then hum.WalkSpeed = tonumber(gui.Main.ContentScroll.SpeedVal.Text) or 50 end
    end
    if movingPart and root then
        movingPart.CanCollide = false
        local targetPos = root.CFrame * CFrame.new(sideOffset, heightOffset, -followDistance)
        alignPos.Position = targetPos.Position
        alignOri.CFrame = CFrame.Angles(math.rad(rotationX), math.rad(rotationY), math.rad(rotationZ))
        if movingPart.AssemblyLinearVelocity.Magnitude < 0.1 then movingPart.AssemblyLinearVelocity = Vector3.new(0, 0.05, 0) end
    end
end)

-- --- STARTUP ---
local function start()
    createUI()
    local t = Instance.new("Tool", player.Backpack); t.Name = "Telekinesis"; t.RequiresHandle = false
    t.Equipped:Connect(function(m) m.Button1Down:Connect(function() if m.Target then togglePartMove(m.Target) end end) end)
    t.Unequipped:Connect(stopMoving)
end

start()
player.CharacterAdded:Connect(function() task.wait(1.5); start() end)
