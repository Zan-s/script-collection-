local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Stats = game:GetService("Stats")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- ==========================================================
-- 1. CUSTOM SCRIPT LIBRARY (SUNTING DI SINI)
-- ==========================================================
local ScriptLibrary = {
    ["1. GUI Startup"] = [[print("GUI Started!")]],
    ["2. Fly System"] = [[print("Paste Fly Script Here")]],
    ["3. Speed Boost"] = [[game.Players.LocalPlayer.Character.Humanoid.WalkSpeed = 100]],
    ["4. Teleport System"] = [[
        local root = game.Players.LocalPlayer.Character.HumanoidRootPart
        root.CFrame = root.CFrame * CFrame.new(0, 50, 0)
    ]],
}

-- --- CONFIGURATION ---
local DEFAULT_DIST, DEFAULT_HEIGHT, DEFAULT_SIDE = 15, 0, 0
local movingPart = nil
local followDistance, heightOffset, sideOffset = DEFAULT_DIST, DEFAULT_HEIGHT, DEFAULT_SIDE
local walkSpeedActive, rotationActive, shiftLockActive, orbitActive = false, true, false, false
local rotationX, rotationY, rotationZ = 0, 0, 0

-- --- UPGRADED PHYSICS (FROM V5) ---
local BP = Instance.new("BodyPosition")
BP.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
BP.P = 15000
BP.D = 1250

local BG = Instance.new("BodyGyro")
BG.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
BG.D = 500

local selectBox = Instance.new("SelectionBox")
selectBox.LineThickness = 0.05
selectBox.Color3 = Color3.fromRGB(255, 255, 255)

-- --- UTILITY FUNCTIONS ---
local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end end)
    UserInputService.InputChanged:Connect(function(input) if input == dragInput and dragging then local delta = input.Position - dragStart; frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
end

local function stopMoving()
    BP.Parent = nil
    BG.Parent = nil
    selectBox.Adornee = nil
    if movingPart then movingPart.CanCollide = true end
    movingPart = nil
end

local function togglePartMove(part)
    if movingPart == part then stopMoving() return end
    stopMoving()
    if part and not part.Anchored then
        movingPart = part.Parent:FindFirstChild("Humanoid") and (part.Parent:FindFirstChild("HumanoidRootPart") or part) or part
        movingPart.CanCollide = false
        
        BP.Parent = movingPart
        BG.Parent = movingPart
        selectBox.Adornee = movingPart
        selectBox.Parent = movingPart
        
        BP.Position = movingPart.Position
    end
end

local function giveTool()
    if player.Backpack:FindFirstChild("T.MAGIC GUNü™Ñ") then return end
    local t = Instance.new("Tool"); t.Name = "T.MAGIC GUNü™Ñ"; t.RequiresHandle = false; t.Parent = player.Backpack
    t.Equipped:Connect(function(mouse)
        -- Support Mobile Touch
        mouse.Button1Down:Connect(function() if mouse.Target then togglePartMove(mouse.Target) end end)
    end)
    t.Unequipped:Connect(stopMoving)
end

local function createBtn(name, text, pos, size, color, parent)
    local b = Instance.new("TextButton", parent); b.Name = name; b.Size = size; b.Position = pos; b.Text = text
    b.BackgroundColor3 = color; b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.GothamBold; b.TextSize = 10; b.ZIndex = 50
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 4); return b
end

local function createSearchBox(parent)
    local s = Instance.new("TextBox", parent)
    s.Size = UDim2.new(0.9, 0, 0, 25); s.Position = UDim2.new(0.05, 0, 0.05, 0)
    s.BackgroundColor3 = Color3.fromRGB(40, 40, 40); s.TextColor3 = Color3.new(1, 1, 1)
    s.PlaceholderText = "Cari Nama..."; s.Text = ""; s.Font = Enum.Font.Gotham; s.TextSize = 12
    s.ZIndex = 50; Instance.new("UICorner", s)
    return s
end

-- --- UI SYSTEM ---
local function createUI()
    if CoreGui:FindFirstChild("TeleMasterV12") then CoreGui.TeleMasterV12:Destroy() end
    local screenGui = Instance.new("ScreenGui", CoreGui); screenGui.Name = "TeleMasterV12"; screenGui.ResetOnSpawn = false

    local main = Instance.new("Frame", screenGui); main.Name = "Main"; main.Size = UDim2.new(0, 240, 0, 400); main.Position = UDim2.new(0.05, 0, 0.2, 0); main.BackgroundColor3 = Color3.fromRGB(15, 15, 15); main.ZIndex = 10; Instance.new("UICorner", main); makeDraggable(main)
    local stroke = Instance.new("UIStroke", main); stroke.Color = Color3.fromRGB(255, 100, 4); stroke.Thickness = 1.5

    createBtn("Header", "MAGICAL,TGUN BY:Dianozan", UDim2.new(0,0,0,0), UDim2.new(1,0,0,35), Color3.fromRGB(30,30,30), main)
    
    local fpsL = Instance.new("TextLabel", main); fpsL.Size = UDim2.new(0.5,0,0,20); fpsL.Position = UDim2.new(0,5,0,-25); fpsL.BackgroundTransparency = 1; fpsL.Font = Enum.Font.Code; fpsL.TextColor3 = Color3.new(1,1,1); fpsL.TextXAlignment = "Left"
    local pngL = Instance.new("TextLabel", main); pngL.Size = UDim2.new(0.5,0,0,20); pngL.Position = UDim2.new(0.5,-5,0,-25); pngL.BackgroundTransparency = 1; pngL.Font = Enum.Font.Code; pngL.TextColor3 = Color3.new(1,1,1); pngL.TextXAlignment = "Right"

    local mainScroll = Instance.new("ScrollingFrame", main)
    mainScroll.Name = "MainScroll"; mainScroll.Size = UDim2.new(1, 0, 1, -40); mainScroll.Position = UDim2.new(0, 0, 0, 40); mainScroll.BackgroundTransparency = 1; mainScroll.BorderSizePixel = 0; mainScroll.ScrollBarThickness = 4; mainScroll.CanvasSize = UDim2.new(0, 0, 0, 620); mainScroll.ScrollBarImageColor3 = Color3.fromRGB(255, 100, 4)

    local slBtn = createBtn("SL", "Lock: OFF", UDim2.new(0.05,0,0,10), UDim2.new(0.28,0,0,25), Color3.fromRGB(40,40,40), mainScroll)
    local pvpBtn = createBtn("PVPTab", "‚òØÔ∏è ORBIT", UDim2.new(0.35,0,0,10), UDim2.new(0.3,0,0,25), Color3.fromRGB(100, 30, 30), mainScroll)
    local customHubBtn = createBtn("HubBtn", "üìú HUB", UDim2.new(0.67,0,0,10), UDim2.new(0.28,0,0,25), Color3.fromRGB(120, 70, 0), mainScroll)
    local npcBtn = createBtn("NPCTab", "üìû NPC LIST", UDim2.new(0.05,0,0,45), UDim2.new(0.43,0,0,25), Color3.fromRGB(30,80,120), mainScroll)
    local blockBtn = createBtn("BlockTab", "üß± BLOCK LIST", UDim2.new(0.52,0,0,45), UDim2.new(0.43,0,0,25), Color3.fromRGB(60,60,60), mainScroll)

    local hUp = createBtn("HU", "‚Üë HEIGHT", UDim2.new(0.05,0,0,80), UDim2.new(0.43,0,0,32), Color3.fromRGB(45,45,45), mainScroll)
    local hDn = createBtn("HD", "‚Üì HEIGHT", UDim2.new(0.52,0,0,80), UDim2.new(0.43,0,0,32), Color3.fromRGB(45,45,45), mainScroll)
    local sLt = createBtn("SLt", "‚Üê LEFT", UDim2.new(0.05,0,0,117), UDim2.new(0.43,0,0,32), Color3.fromRGB(55,55,55), mainScroll)
    local sRt = createBtn("SRt", "RIGHT ‚Üí", UDim2.new(0.52,0,0,117), UDim2.new(0.43,0,0,32), Color3.fromRGB(55,55,55), mainScroll)
    local dPl = createBtn("DP", "+ DIST", UDim2.new(0.05,0,0,154), UDim2.new(0.43,0,0,32), Color3.fromRGB(30,55,85), mainScroll)
    local dMi = createBtn("DM", "- DIST", UDim2.new(0.52,0,0,154), UDim2.new(0.43,0,0,32), Color3.fromRGB(30,55,85), mainScroll)
    
    local rotToggle = createBtn("RotTog", "ROTATION: ON", UDim2.new(0.05,0,0,195), UDim2.new(0.9,0,0,30), Color3.fromRGB(50,100,50), mainScroll)
    local rotBtn = createBtn("Rot", "‚öôÔ∏è REMOTE ROTATE", UDim2.new(0.05,0,0,230), UDim2.new(0.9,0,0,32), Color3.fromRGB(70,35,110), mainScroll)
    local flBtn = createBtn("Fling", "üî• FLING (FORCE)", UDim2.new(0.05,0,0,270), UDim2.new(0.9,0,0,35), Color3.fromRGB(150,45,45), mainScroll)
    
    local wsTog = createBtn("WSTog", "WALKSPEED: OFF", UDim2.new(0.05,0,0,315), UDim2.new(0.9,0,0,30), Color3.fromRGB(40,40,40), mainScroll)
    local wsInp = Instance.new("TextBox", mainScroll); wsInp.Size = UDim2.new(0.9,0,0,25); wsInp.Position = UDim2.new(0.05,0,0,350); wsInp.Text = "50"; wsInp.BackgroundColor3 = Color3.new(0,0,0); wsInp.TextColor3 = Color3.new(1,1,1); Instance.new("UICorner", wsInp)
    local resBtn = createBtn("Res", "‚ôªÔ∏è RESET", UDim2.new(0.05,0,0,385), UDim2.new(0.9,0,0,30), Color3.fromRGB(180,90,0), mainScroll)
    local cloBtn = createBtn("Clo", "‚ùå CLOSE UI", UDim2.new(0.05,0,0,425), UDim2.new(0.9,0,0,30), Color3.fromRGB(40,40,40), mainScroll)

    -- --- SUB FRAMES ---
    local function createSubFrame(name)
        local f = Instance.new("Frame", screenGui); f.Name = name; f.Size = UDim2.new(0, 200, 0, 320); f.Position = UDim2.new(0.7, 0, 0.2, 0); f.BackgroundColor3 = Color3.fromRGB(20, 20, 20); f.Visible = false; Instance.new("UICorner", f); makeDraggable(f)
        Instance.new("UIStroke", f).Color = Color3.fromRGB(255, 100, 4)
        local sBox = createSearchBox(f)
        local scroll = Instance.new("ScrollingFrame", f); scroll.Size = UDim2.new(0.9,0,0.75,0); scroll.Position = UDim2.new(0.05,0,0.15,0); scroll.BackgroundTransparency = 1; scroll.CanvasSize = UDim2.new(0,0,0,0); scroll.ScrollBarThickness = 3
        local list = Instance.new("UIListLayout", scroll); list.Padding = UDim.new(0,5)
        local ref = createBtn("Ref", "üîÑ REFRESH", UDim2.new(0.05,0,0.91,0), UDim2.new(0.9,0,0,25), Color3.fromRGB(40,60,90), f)
        return f, scroll, sBox, ref
    end

    local nFrame, nScroll, nSearch, nRef = createSubFrame("NPCFrame")
    local bFrame, bScroll, bSearch, bRef = createSubFrame("BlockFrame")
    local cFrame, cScroll, cSearch, cRef = createSubFrame("CustomHub")
    cSearch:Destroy() -- Hub tak perlu search box

    -- Auto Button Hub
    for name, code in pairs(ScriptLibrary) do
        local b = createBtn("Script", name, UDim2.new(0,0,0,0), UDim2.new(1,0,0,30), Color3.fromRGB(45,45,45), cScroll)
        b.MouseButton1Click:Connect(function()
            local func = loadstring(code)
            if func then func() end
        end)
    end
    cScroll.CanvasSize = UDim2.new(0,0,0, cScroll.UIListLayout.AbsoluteContentSize.Y)

    local remote = Instance.new("Frame", screenGui); remote.Name = "Remote"; remote.Size = UDim2.new(0, 150, 0, 180); remote.Position = UDim2.new(0.3, 0, 0.4, 0); remote.BackgroundColor3 = Color3.fromRGB(20, 20, 20); remote.Visible = false; Instance.new("UICorner", remote); makeDraggable(remote)

    -- --- CONTROLS LOGIC ---
    hUp.MouseButton1Click:Connect(function() heightOffset += 2 end)
    hDn.MouseButton1Click:Connect(function() heightOffset -= 2 end)
    sLt.MouseButton1Click:Connect(function() sideOffset -= 2 end)
    sRt.MouseButton1Click:Connect(function() sideOffset += 2 end)
    dPl.MouseButton1Click:Connect(function() followDistance += 5 end)
    dMi.MouseButton1Click:Connect(function() followDistance = math.max(2, followDistance - 5) end)

    slBtn.MouseButton1Click:Connect(function() 
        shiftLockActive = not shiftLockActive
        slBtn.Text = "Lock: " .. (shiftLockActive and "ON" or "OFF")
        slBtn.BackgroundColor3 = shiftLockActive and Color3.fromRGB(50, 100, 50) or Color3.fromRGB(40, 40, 40)
    end)

    pvpBtn.MouseButton1Click:Connect(function()
        orbitActive = not orbitActive
        pvpBtn.Text = orbitActive and "‚òØÔ∏è STOP" or "‚òØÔ∏è ORBIT"
        pvpBtn.BackgroundColor3 = orbitActive and Color3.fromRGB(50,150,50) or Color3.fromRGB(100,30,30)
    end)

    local function populateList(scroll, searchBox, isNPC)
        for _, c in pairs(scroll:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
        local query = searchBox.Text:lower()
        for _, v in pairs(workspace:GetDescendants()) do
            local valid = false
            if isNPC and v:IsA("Humanoid") and v.Parent ~= player.Character and not Players:GetPlayerFromCharacter(v.Parent) then valid = v.Parent
            elseif not isNPC and v:IsA("BasePart") and not v.Anchored and v.Name ~= "Baseplate" and not v:IsDescendantOf(player.Character) and not v.Parent:FindFirstChild("Humanoid") then valid = v end
            if valid and valid.Name:lower():find(query) then
                local b = createBtn("Item", valid.Name, UDim2.new(0,0,0,0), UDim2.new(1,0,0,25), Color3.fromRGB(40,40,40), scroll)
                b.MouseButton1Click:Connect(function()
                    local root = player.Character:FindFirstChild("HumanoidRootPart")
                    local target = valid:IsA("Model") and (valid:FindFirstChild("HumanoidRootPart") or valid:FindFirstChild("Head")) or valid
                    if root and target then 
                        if target:IsA("BasePart") then target.CFrame = root.CFrame * CFrame.new(0, 0, -5)
                        else target.Parent:SetPrimaryPartCFrame(root.CFrame * CFrame.new(0, 0, -5)) end
                    end
                end)
            end
        end
        scroll.CanvasSize = UDim2.new(0,0,0, scroll.UIListLayout.AbsoluteContentSize.Y)
    end

    nSearch:GetPropertyChangedSignal("Text"):Connect(function() populateList(nScroll, nSearch, true) end)
    bSearch:GetPropertyChangedSignal("Text"):Connect(function() populateList(bScroll, bSearch, false) end)
    nRef.MouseButton1Click:Connect(function() populateList(nScroll, nSearch, true) end)
    bRef.MouseButton1Click:Connect(function() populateList(bScroll, bSearch, false) end)

    npcBtn.MouseButton1Click:Connect(function() nFrame.Visible = not nFrame.Visible; bFrame.Visible = false; cFrame.Visible = false; if nFrame.Visible then populateList(nScroll, nSearch, true) end end)
    blockBtn.MouseButton1Click:Connect(function() bFrame.Visible = not bFrame.Visible; nFrame.Visible = false; cFrame.Visible = false; if bFrame.Visible then populateList(bScroll, bSearch, false) end end)
    customHubBtn.MouseButton1Click:Connect(function() cFrame.Visible = not cFrame.Visible; nFrame.Visible = false; bFrame.Visible = false end)
    
    local menuToggle = createBtn("MENU", "‚ò∞", UDim2.new(0.02,0,0.05,0), UDim2.new(0,45,0,45), Color3.fromRGB(25,25,25), screenGui)
    Instance.new("UICorner", menuToggle).CornerRadius = UDim.new(0, 22.5); makeDraggable(menuToggle)
    menuToggle.MouseButton1Click:Connect(function() main.Visible = not main.Visible; nFrame.Visible = false; bFrame.Visible = false; remote.Visible = false; cFrame.Visible = false end)

    -- Remote Control
    local rxP = createBtn("XP", "X+", UDim2.new(0.1,0,0.1,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rxM = createBtn("XM", "X-", UDim2.new(0.55,0,0.1,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local ryP = createBtn("YP", "Y+", UDim2.new(0.1,0,0.4,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local ryM = createBtn("YM", "Y-", UDim2.new(0.55,0,0.4,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rzP = createBtn("ZP", "Z+", UDim2.new(0.1,0,0.7,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)
    local rzM = createBtn("ZM", "Z-", UDim2.new(0.55,0,0.7,0), UDim2.new(0.35,0,0,35), Color3.fromRGB(55,55,55), remote)

    rxP.MouseButton1Click:Connect(function() rotationX += 30 end); rxM.MouseButton1Click:Connect(function() rotationX -= 30 end)
    ryP.MouseButton1Click:Connect(function() rotationY += 30 end); ryM.MouseButton1Click:Connect(function() rotationY -= 30 end)
    rzP.MouseButton1Click:Connect(function() rotationZ += 30 end); rzM.MouseButton1Click:Connect(function() rotationZ -= 30 end)
    rotBtn.MouseButton1Click:Connect(function() remote.Visible = not remote.Visible end)

    -- --- LOOP LOGIC ---
    RunService.RenderStepped:Connect(function()
        pcall(function()
            fpsL.Text = "FPS: "..math.floor(1/RunService.RenderStepped:Wait())
            pngL.Text = "Ping: "..math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue()).."ms"
            if shiftLockActive and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
                local root = player.Character.HumanoidRootPart
                local lookVector = camera.CFrame.LookVector
                root.CFrame = CFrame.new(root.Position, root.Position + Vector3.new(lookVector.X, 0, lookVector.Z))
            end
        end)
    end)

    RunService.Heartbeat:Connect(function()
        local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if not root then return end
        if movingPart and not orbitActive then
            local targetPos = root.Position + (root.CFrame.LookVector * followDistance) + (root.CFrame.UpVector * heightOffset) + (root.CFrame.RightVector * sideOffset)
            BP.Position = targetPos
            BG.CFrame = CFrame.Angles(math.rad(rotationX), math.rad(rotationY), math.rad(rotationZ))
        end
    end)

    rotToggle.MouseButton1Click:Connect(function() 
        rotationActive = not rotationActive
        rotToggle.Text = "ROTATION: "..(rotationActive and "ON" or "OFF")
        rotToggle.BackgroundColor3 = rotationActive and Color3.fromRGB(50,100,50) or Color3.fromRGB(100,50,50)
        BG.Enabled = rotationActive
    end)

    flBtn.MouseButton1Click:Connect(function() if movingPart then local p = movingPart; stopMoving(); p.AssemblyLinearVelocity = camera.CFrame.LookVector * 1000 end end)
    wsTog.MouseButton1Click:Connect(function() walkSpeedActive = not walkSpeedActive; wsTog.Text = "WALKSPEED: "..(walkSpeedActive and "ON" or "OFF"); if player.Character:FindFirstChild("Humanoid") then player.Character.Humanoid.WalkSpeed = walkSpeedActive and tonumber(wsInp.Text) or 16 end end)
    resBtn.MouseButton1Click:Connect(function() heightOffset, sideOffset, followDistance, rotationX, rotationY, rotationZ = 0, 0, 15, 0, 0, 0 end)
    cloBtn.MouseButton1Click:Connect(function() screenGui:Destroy() end)
end

createUI()
giveTool()
player.CharacterAdded:Connect(function() task.wait(0.5); giveTool() end)
